<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>AI Wife - 3D Character Interaction</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- 認証チェック: ページ読み込み前にチェック -->
    <script>
        // アクセストークンの存在確認（ゲストモードも許可）
        // ログインページでない場合のみチェック
        (function() {
            // 認証は任意なので、このチェックを削除またはコメントアウト
            // const accessToken = localStorage.getItem('access_token');
            // if (!accessToken) {
            //     window.location.href = '/auth/login.html';
            // }
        })();
    </script>
</head>
<body>
    <!-- ハンバーガーメニュー -->
    <div class="hamburger-menu" id="hamburgerMenu">
        <i class="fas fa-bars"></i>
    </div>

    <!-- チャット履歴メニュー -->
    <div class="chat-history-menu" id="chatHistoryMenu">
        <i class="fas fa-comments"></i>
    </div>

    <!-- サイドバー -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>AI Wife Settings</h3>
            <button class="close-sidebar" id="closeSidebar">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="sidebar-content">
            <div class="setting-group">
                <h4>キャラクター設定</h4>
                <div class="setting-item">
                    <label for="characterSelect">キャラクター:</label>
                    <select id="characterSelect">
                        <option value="avatar.vrm">レイ (AIエンジニア)</option>
                        <option value="yui.vrm" selected>ユイ (天然な癒し系)</option>
                    </select>
                </div>
                
                <div class="setting-item">
                    <label for="characterUpload">モデルアップロード (.vrm):</label>
                    <input type="file" id="characterUpload" accept=".vrm" style="display: none;">
                    <button class="upload-button" onclick="document.getElementById('characterUpload').click()">
                        <i class="fas fa-upload"></i> VRMファイルを選択
                    </button>
                    <span id="characterUploadStatus" class="upload-status"></span>
                </div>
                
                <div class="setting-item">
                    <label for="backgroundSelect">背景画像:</label>
                    <select id="backgroundSelect">
                        <option value="none">なし（透明）</option>
                        <option value="sky.jpg">空間</option>
                        <option value="room.jpg">研究室</option>
                        <option value="garden.jpg">夜空</option>
                    </select>
                </div>
                
                <div class="setting-item">
                    <label for="backgroundUpload">背景アップロード (.jpg):</label>
                    <input type="file" id="backgroundUpload" accept=".jpg,.jpeg" style="display: none;">
                    <button class="upload-button" onclick="document.getElementById('backgroundUpload').click()">
                        <i class="fas fa-upload"></i> JPGファイルを選択
                    </button>
                    <span id="backgroundUploadStatus" class="upload-status"></span>
                </div>
                
                <div class="setting-item">
                    <label for="memoryToggle">記憶機能:</label>
                    <input type="checkbox" id="memoryToggle" checked>
                </div>
                
                <div class="setting-item">
                    <label for="use3DUIToggle">3D UIモード:</label>
                    <input type="checkbox" id="use3DUIToggle" checked>
                </div>
            </div>
            
            <div class="setting-group">
                <h4>音声設定</h4>
                <div class="setting-item">
                    <label for="volumeSlider">音量:</label>
                    <input type="range" id="volumeSlider" min="0" max="100" value="70">
                    <span id="volumeValue">70%</span>
                </div>
                
                <div class="setting-item">
                    <label for="voiceSpeed">話速:</label>
                    <input type="range" id="voiceSpeed" min="0.5" max="2.0" step="0.1" value="1.0">
                    <span id="voiceSpeedValue">1.0x</span>
                </div>
            </div>
            
            <div class="setting-group">
                <button class="reset-button" id="resetMemory">
                    <i class="fas fa-trash"></i> 記憶をリセット
                </button>
            </div>
            
            <div class="setting-group auth-group">
                <h4>アカウント</h4>
                <div id="authButtons">
                    <!-- ログイン状態に応じて動的に変更 -->
                </div>
            </div>
        </div>
    </div>

    <!-- チャット履歴サイドバー -->
    <div class="chat-history-sidebar" id="chatHistorySidebar">
        <div class="sidebar-header">
            <h3>チャット履歴</h3>
            <button class="close-sidebar" id="closeChatHistory">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="chat-history-content">
            <div class="history-search">
                <input type="text" id="historySearch" placeholder="履歴を検索...">
                <i class="fas fa-search"></i>
            </div>
            
            <div class="history-list" id="historyList">
                <!-- チャット履歴がここに表示される -->
            </div>
            
            <div class="history-actions">
                <button class="clear-history-button" id="clearHistory">
                    <i class="fas fa-trash-alt"></i> 履歴をクリア
                </button>
            </div>
        </div>
    </div>

    <!-- メインコンテンツ -->
    <div class="main-content" id="mainContent">
        <!-- 3Dキャラクター表示領域 -->
        <div class="character-container" id="characterContainer">
            <!-- Three.jsでレンダリングされる -->
        </div>
        
        <!-- ステータス表示 -->
        <div class="status-bar">
            <div class="connection-status" id="connectionStatus">
                <i class="fas fa-circle text-gray"></i>
                <span>接続中...</span>
            </div>
            <div class="character-mood" id="characterMood">
                <i class="fas fa-smile"></i>
                <span>普通</span>
            </div>
        </div>
    </div>

    <!-- ローディングオーバーレイ -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>AI が考えています...</p>
        </div>
    </div>

    <!-- エラートースト -->
    <div class="toast error-toast" id="errorToast" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i>
        <span id="errorMessage">エラーが発生しました</span>
        <button class="toast-close" onclick="hideErrorToast()">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Scripts -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.177.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.177.0/examples/jsm/",
                "@pixiv/three-vrm": "https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@3/lib/three-vrm.module.js",
                "@pixiv/three-vrm-animation": "https://cdn.jsdelivr.net/npm/@pixiv/three-vrm-animation@3/lib/three-vrm-animation.module.js"
            }
        }
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script type="module" src="js/app.js"></script>
</body>
</html>